#!/bin/bash
# ##################################################################################################
# アーカイブ生成
# 
# 本プロジェクトの配布用アーカイブを以下ディレクトリに生成する。
# 
#   dist/
#    ├*.whl
#    └*.tar.gz
# 
# tar.gzファイルはソースコード配布物であり、whlファイルはビルド済み配布物
# 
# [Memo]
# 以下のようなエラーが発生する場合
#   /usr/bin/python3: No module named build
# 以下をインストールで解消
#   sudo apt install python3-build
# ##################################################################################################
# ==================================================================================================
# ビルド実施
# ==================================================================================================
# --------------------------------------------------------------------------------------------------
# 環境情報取得
# --------------------------------------------------------------------------------------------------
# 本シェルの格納ディレクトリを取得
OWNSHELLSCRIPT_DIR="$(dirname $0)"
# --------------------------------------------------------------------------------------------------
# ディレクトリ移動
# --------------------------------------------------------------------------------------------------
# 本シェルが格納されているディレクトリに移動
# ※pyproject.tomlが存在するディレクトリでビルドコマンドを実行する必要があるため
cd "${OWNSHELLSCRIPT_DIR}"

# --------------------------------------------------------------------------------------------------
# ビルド実施
# --------------------------------------------------------------------------------------------------
# パイプ全体でどれか一つでも失敗したら終了コードが非0とするよう設定
# set -o pipefail
WHL_FILENAME=$(python3 -m build | tee /dev/tty | tail -n 1 | awk '{print $5}')

# --------------------------------------------------------------------------------------------------
# 元いたディレクトリに戻る
# --------------------------------------------------------------------------------------------------
cd - 1>/dev/null

# --------------------------------------------------------------------------------------------------
# 正常終了したかを変数の格納結果を見て判定
# --------------------------------------------------------------------------------------------------
# 正常終了した場合
if [ "${WHL_FILENAME}" != "" ]; then
    # インストールコマンドを生成し表示する
    echo "# ------------------------------------------------"
    echo "# pip install ${OWNSHELLSCRIPT_DIR}/dist/${WHL_FILENAME}"
    echo "# ------------------------------------------------"
    exit 0
# 異常終了した場合
else
    exit 1
fi
